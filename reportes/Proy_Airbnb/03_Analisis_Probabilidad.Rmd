---
title: "C√°lculo de Probabilidades en Airbnb"
author: "Enrique D√≠az Ocampo"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# 1Ô∏è‚É£ Introducci√≥n

Este an√°lisis tiene como objetivo calcular probabilidades condicionales en el dataset de Airbnb, respondiendo preguntas como:

- ¬øCu√°l es la probabilidad de que un alojamiento tenga un precio accesible (<$100 USD) en ciertos barrios?

- ¬øC√≥mo influye el tipo de habitaci√≥n en la disponibilidad del alojamiento?

- ¬øQu√© tan probable es que un alojamiento tenga m√°s de 3 ba√±os si su precio es alto?

Estos c√°lculos son clave para entender patrones de precios y disponibilidad en distintos barrios de la ciudad.

# 2Ô∏è‚É£ Carga de Librer√≠as y Configuraci√≥n

```{r}
install.packages("here",dependencies = TRUE)
library(here)           # Manejo de rutas din√°micas
source(here("reportes/Proy_Airbnb/00_CONFIGURACION.r"))
```

```{r}
# üìå Cargar librer√≠as necesarias
library(janitor)        # Limpieza de nombres de columnas
library(summarytools)   # Resumen estad√≠stico detallado
library(ggplot2)        # Gr√°ficos
library(dplyr)          # Manipulaci√≥n de datos
library(plotly)         # Gr√°ficos Interactivos

# üìå Configuraci√≥n de gr√°ficos globales
theme_set(theme_minimal())

# üìå Cargar scripts de preprocesamiento
source(here("scripts/utils.r"))
source(here("scripts/1_preprocesamiento_esp_dataset.r"))
source(here("scripts/3_analisis_probabilidad.r"))

```



```{r}
# üìå Cargar dataset limpio
airbnb_data <- preprocesar_datos(here("datasets/listings_filtered.csv"), "Airbnb")

```


# 3Ô∏è‚É£ C√°lculo de Probabilidades Condicionales

En esta secci√≥n analizamos la relaci√≥n entre tipo de alojamiento, precios y disponibilidad, aplicando c√°lculos de probabilidad condicional.

üìå Probabilidad de que un alojamiento tenga un precio accesible (<1000) en barrios seleccionados

```{r}
barrios_seleccionados <- c("Cuauht√©moc","√Ålvaro Obreg√≥n","Azcapotzalco") 

# Calcular probabilidades
resultados_precio_barrio <- calcular_probabilidades(
  data = airbnb_data %>% filter(neighbourhood_cleansed %in% barrios_seleccionados),
  condicionante = "neighbourhood_cleansed",
  objetivo = "price",
  bins = 5  # Dividir el precio en intervalos
)

# Mostrar resultados
cat("Tabla de contingencia:\n")
print(resultados_precio_barrio$tabla_contingencia)

cat("\nProbabilidades condicionales:\n")
print(resultados_precio_barrio$probabilidades_condicionales)

cat("\nProbabilidades marginales de precio:\n")
print(resultados_precio_barrio$probabilidades_marginales)

```



# üìå Probabilidad de que un alojamiento tenga m√°s de 3 ba√±os dado que su precio es alto .

```{r}
# üìå Definir los bins para cada variable
bins_price <- seq(0, max(airbnb_data$price, na.rm = TRUE), by = 100)  # Intervalos de 100 USD
bins_bathrooms <- seq(0, max(airbnb_data$bathrooms, na.rm = TRUE), by = 0.5)  # Intervalos de 0.5 ba√±os

# üìå Transformar los datos antes de calcular probabilidades
airbnb_data_binned <- airbnb_data %>%
  filter(price > 0, price < 1000,neighbourhood_cleansed %in% barrios_seleccionados) %>%  # Filtrando valores extremos
  mutate(
    price = cut(price, breaks = bins_price, include.lowest = TRUE),  # Convertir en categor√≠as
    bathrooms = cut(bathrooms, breaks = bins_bathrooms, include.lowest = TRUE)  # Convertir en categor√≠as
  )

# üìå Calcular la probabilidad condicional de ba√±os dado el precio
resultados_bathrooms_vs_price <- calcular_probabilidades(
  data = airbnb_data_binned,  # Dataset con variables discretizadas
  condicionante = "price",  # Precio del alojamiento
  objetivo = "bathrooms"  # N√∫mero de ba√±os
)

# üìå Mostrar resultados corregidos
cat("Tabla de contingencia:\n")
print(resultados_bathrooms_vs_price$tabla_contingencia)

cat("\nProbabilidades condicionales:\n")
print(resultados_bathrooms_vs_price$probabilidades_condicionales)

cat("\nProbabilidades marginales de ba√±os:\n")
print(resultados_bathrooms_vs_price$probabilidades_marginales)





```

# üìä Visualizaci√≥n: Probabilidad de Tipo de Habitaci√≥n por Barrio

```{r}
p_room_type_barrio <- visualizar_probabilidad_condicional(
  data = airbnb_data %>% filter(neighbourhood_cleansed %in% barrios_seleccionados),
  condicionante = "neighbourhood_cleansed",
  objetivo = "room_type",
  titulo = "Probabilidad de Tipo de Habitaci√≥n por Barrio en Airbnb",
  xlab = "Barrio",
  guardar = TRUE,
  ruta_guardado = here("reportes/Proy_Airbnb/resultados_generados/probabilidad_condicional_room_type_barrio.png")
)

p_room_type_barrio

```



# üìä Visualizaci√≥n: Probabilidad de Precio por Barrio

```{r}
p_precio_barrio <- visualizar_probabilidad_condicional(
  data = airbnb_data %>% filter(neighbourhood_cleansed %in% barrios_seleccionados),
  condicionante = "neighbourhood_cleansed",
  objetivo = "price",
  titulo = "Probabilidad de Precio por Barrio en Airbnb",
  xlab = "Barrio",
  guardar = TRUE,
  ruta_guardado = here("reportes/Proy_Airbnb/resultados_generados/probabilidad_condicional_precio_barrio.png"),
  bins = seq(0, max(airbnb_data$price, na.rm = TRUE), by = 100)
)

p_precio_barrio

```





# üìä Visualizaci√≥n: Probabilidad de N√∫mero de Ba√±os dado el Precio

```{r}
p_bathrooms_price <- visualizar_probabilidad_condicional(
  data = airbnb_data_binned,
  condicionante = "price",
  objetivo = "bathrooms",
  titulo = "Probabilidad de N√∫mero de Ba√±os dado el Precio en Airbnb",
  xlab = "Precio (USD)",
  guardar = TRUE,
  ruta_guardado = here("reportes/Proy_Airbnb/resultados_generados/probabilidad_condicional_bathrooms_vs_price.png"),
  bins = bins_price
)

# Ajustar etiquetas del eje X en plotly
p_bathrooms_price <- p_bathrooms_price %>% layout(xaxis = list(tickangle = 90))

# Mostrar el gr√°fico interactivo
p_bathrooms_price

```




# ‚úÖ Conclusi√≥n

Hemos aplicado c√°lculos de probabilidad condicional para explorar la relaci√≥n entre precios, n√∫mero de ba√±os, barrios y tipo de habitaci√≥n en Airbnb. Estas visualizaciones permiten una mejor interpretaci√≥n de los datos para decisiones de inversi√≥n o an√°lisis de tendencias.


