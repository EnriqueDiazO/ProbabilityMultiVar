---
title: "Gu√≠a de Gr√°ficos para el An√°lisis Exploratorio de Datos (EDA)"
author: "Enrique D√≠az Ocampo"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


# 1Ô∏è‚É£ Introducci√≥n

Esta gu√≠a proporciona una serie de gr√°ficos para realizar un An√°lisis Exploratorio de Datos (EDA) en diferentes niveles:

- An√°lisis Unidimensional: Distribuci√≥n de una sola variable.

- An√°lisis Multivariado: Relaci√≥n entre dos o m√°s variables.

- Visualizaci√≥n con ggplot2 para explorar patrones en los datos.

Esta gu√≠a te ayudar√° a seleccionar el gr√°fico m√°s adecuado seg√∫n el tipo de variable analizada en el contexto de listings de Airbnb, analizando la distribuci√≥n de precios, tipos de alojamiento, ubicaci√≥n y disponibilidad.

# 2Ô∏è‚É£ Carga de Librer√≠as y Configuraci√≥n
```{r}
install.packages("here",dependencies = TRUE)
library(here)           # Manejo de rutas din√°micas
source(here("reportes/Proy_Education_Career_Success/00_CONFIGURACION.r"))
```

```{r}
#  Cargar librer√≠as necesarias
library(janitor)        # Limpieza de nombres de columnas
library(summarytools)   # Resumen estad√≠stico detallado
library(ggplot2)        # Gr√°ficos
library(dplyr)          # Manipulaci√≥n de datos
library(plotly)         # Gr√°ficos Interactivos
library(htmlwidgets)
# Configuraci√≥n de gr√°ficos globales
theme_set(theme_minimal())

# Cargar scripts de preprocesamiento
source(here("scripts/utils.r"))
source(here("scripts/1_preprocesamiento_esp_dataset.r"))
source(here("scripts/2_analisis_gr√°fico.r"))

```


# 3Ô∏è‚É£ Carga y Preprocesamiento de Datos

üìå ¬øQu√© hace esta funci√≥n?

‚úî Limpia los nombres de las columnas.

‚úî Convierte variables categ√≥ricas en factores.

‚úî Filtra valores inv√°lidos.

‚úî Retorna un dataset listo para an√°lisis.

```{r}
# üìå Cargar y preprocesar el dataset
airbnb_data <- preprocesar_datos(here("datasets/listings_filtered.csv"), "Airbnb")
```

# 4Ô∏è‚É£ An√°lisis Unidimensional

El an√°lisis unidimensional permite estudiar la distribuci√≥n de una sola variable.

## üìå Boxplot para una variable cuantitativa (Precio)

```{r}
p_boxplot_precio <- crear_boxplot(
  data = airbnb_data,
  y = "price",
  title = "Distribuci√≥n de Precios en Airbnb",
  xlab = "Alojamientos",
  ylab = "Precio (USD)",
  fill = NULL,
  colores = "blue"
) +
  scale_y_log10()  # Aplicar escala logar√≠tmica al eje Y

# Guardar y mostrar el gr√°fico
guardar_grafico(p_boxplot_precio, here("reportes/Proy_Airbnb/resultados_generados/boxplot_precio.png"))
convertir_interactivo(p_boxplot_precio)

```


## üìå Histograma para una variable cuantitativa (N√∫mero de Noches M√≠nimas)

```{r}
max_nights = 60 # M√°ximo n√∫mero de noches
p_histograma_min_nights <- crear_histograma(
  data = airbnb_data %>% filter(minimum_nights < max_nights),  # Filtramos valores extremos
  x = "minimum_nights",
  title = "Distribuci√≥n de Noches M√≠nimas en Airbnb",
  xlab = "Noches M√≠nimas",
  ylab = "Frecuencia",
  binwidth = 1,  # Usamos bins m√°s peque√±os para mejor resoluci√≥n
  colores = "lightblue",
  densidad = FALSE  # Quitamos la l√≠nea de densidad
) + 
  scale_x_continuous(breaks = seq(0, max_nights, 3))  # Agregamos m√°s etiquetas en el eje X

# Guardar el gr√°fico
guardar_grafico(p_histograma_min_nights, here("reportes/Proy_Airbnb/resultados_generados/histograma_minimum_nights.png"))

# Convertir a gr√°fico interactivo
convertir_interactivo(p_histograma_min_nights)


```


# üìå  Comparaci√≥n de Histogramas de Precio por Tipo de Propiedad 
```{r}
# Definir colores y etiquetas para la leyenda
colores_property_type <- c("Entire home/apt" = "blue", "Private room" = "red", "Shared room" = "cyan", "Hotel room" = "purple")
etiquetas_leyenda <- c("Casa/Apartamento Entero", "Habitaci√≥n Privada", "Habitaci√≥n Compartida", "Hotel")

barrios_seleccionados <- c("Cuauht√©moc")  # üîπ Cambia esto al barrio que quieras analizar

#√Ålvaro Obreg√≥n           Azcapotzalco          Benito Ju√°rez               Coyoac√°n  Cuajimalpa de Morelos 
#Cuauht√©moc      Gustavo A. Madero              Iztacalco             Iztapalapa La Magdalena Contreras 
#Miguel Hidalgo             Milpa Alta                Tl√°huac                Tlalpan    Venustiano Carranza 
#Xochimilco 

# Crear histograma superpuesto

p_price_histogram <- crear_histograma_filtrado(
  data = airbnb_data %>% filter(price > 0, price < 1000, neighbourhood_cleansed %in% barrios_seleccionados) ,
  filtro_columna = "room_type",
  filtro_valor = c("Private room","Entire home/apt"),
  x = "price",
  fill = "room_type",
  title = "Distribuci√≥n de Precios seg√∫n Tipo de Habitaci√≥n " ,
  xlab = "Precio",
  ylab = "Frecuencia",
  binwidth = 50,
  colores = colores_property_type,
  etiquetas_leyenda = etiquetas_leyenda
)

# Guardar el gr√°fico
guardar_grafico(p_price_histogram, here("reportes/Proy_Airbnb/resultados_generados/histograma_price_room_type.png"))

# Convertir a gr√°fico interactivo
convertir_interactivo(p_price_histogram)

```



üìå Barplot para una variable cualitativa (Tipo de Propiedad)

```{r}
# Ajustar tama√±o del gr√°fico y mejorar etiquetas
p_barplot_property <- crear_barplot(
  data = airbnb_data %>% filter(price > 0, price < 1000, neighbourhood_cleansed %in% barrios_seleccionados),
  x = "property_type",
  fill = "property_type",
  title = "Tipos de Propiedad en Airbnb",
  xlab = "Tipo de Propiedad",
  ylab = "Frecuencia",
  dodge = FALSE,
  voltear = TRUE,
  legend_position = "none"
) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),  # Agrandar t√≠tulo
    axis.title = element_text(size = 16, face = "bold"),  # Agrandar etiquetas de los ejes
    axis.text.x = element_text(size = 14),  # Agrandar n√∫meros del eje X
    axis.text.y = element_text(size = 12, hjust = 1)  # Agrandar etiquetas del eje Y y alinearlas
  )

# Guardar el gr√°fico con mayor tama√±o
ggsave(here("reportes/Proy_Airbnb/resultados_generados/barplot_property_type.png"),
       plot = p_barplot_property, width = 12, height = 8, bg = "white")  # üìå Aumenta tama√±o de la imagen

# Convertir a gr√°fico interactivo
convertir_interactivo(p_barplot_property)

```


# 5Ô∏è‚É£ An√°lisis Multivariado

El an√°lisis multivariado permite explorar relaciones entre dos o m√°s variables.

üìå Cualitativa vs Cualitativa (Distribuci√≥n de Tipos de Habitaci√≥n por Regi√≥n)

```{r}
barrios_seleccionados <- c("Cuauht√©moc","√Ålvaro Obreg√≥n","Azcapotzalco")  # üîπ Cambia esto al barrio que quieras analizar

p_region_room_type <- crear_barplot(
  data =  airbnb_data %>% filter(price > 0, price < 1000, neighbourhood_cleansed %in% barrios_seleccionados),
  x = "neighbourhood_cleansed",
  fill = "room_type",
  title = "Distribuci√≥n de Tipos de Habitaci√≥n por Regi√≥n",
  xlab = "Regi√≥n",
  ylab = "Frecuencia",
  dodge = TRUE,
  voltear = FALSE,
  legend_position = "right"
)

# Guardar el gr√°fico
guardar_grafico(p_region_room_type, here("reportes/Proy_Airbnb/resultados_generados/barplot_region_room_type.png"))

# Convertir a gr√°fico interactivo
convertir_interactivo(p_region_room_type)

```

# üìå Cuantitativa vs Cualitativa (Boxplot de Precio por Tipo de Propiedad)

```{r}
barrios_seleccionados <- c("Cuauht√©moc","√Ålvaro Obreg√≥n","Azcapotzalco")  # üîπ Cambia esto al barrio que quieras analizar

p_boxplot_price_property <- crear_boxplot(
  data = airbnb_data %>% filter(price > 0, price < 1000, neighbourhood_cleansed %in% barrios_seleccionados),
  x = "property_type",
  y = "price",
  fill = "property_type",
  title = "Distribuci√≥n de Precios por Tipo de Propiedad en Airbnb",
  xlab = "Tipo de Propiedad",
  ylab = "Precio (USD)",
  fill_lab = "Tipo de Propiedad",
  colores = NULL,
  rotar_x = TRUE
) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8), legend.position = "none")

# Guardar el gr√°fico
guardar_grafico(p_boxplot_price_property, here("reportes/Proy_Airbnb/resultados_generados/boxplot_price_property.png"))

# Convertir a gr√°fico interactivo
convertir_interactivo(p_boxplot_price_property)

```


## üìå Cuantitativa vs Cualitativa (Boxplot de Precio por Tipo de Propiedad)

```{r}
# Seleccionar barrios espec√≠ficos
barrios_seleccionados <- c("Cuauht√©moc", "√Ålvaro Obreg√≥n", "Azcapotzalco")  

# Definir colores personalizados para cada tipo de habitaci√≥n
colores_room_type <- c("Entire home/apt" = "#2980B9", "Private room" = "#E74C3C", 
                       "Shared room" = "#27AE60", "Hotel room" = "#8E44AD")

# Filtrar datos seg√∫n la restricci√≥n y contar registros por tipo de propiedad
filtered_data <- airbnb_data %>%
  filter(price > 0, price < 1000, neighbourhood_cleansed %in% barrios_seleccionados) %>%
  group_by(property_type) %>%
  filter(n() >= 10) %>%  # üîπ Solo incluir property_type con al menos 10 registros
  ungroup()

# Crear el gr√°fico interactivo
p_boxplot_precio <- crear_boxplot_interactivo(
  data = filtered_data,
  x = "property_type",  # Variable para el eje X
  y = "price",  # Variable para el eje Y
  color = "room_type",  # Variable para el color (tipo de habitaci√≥n)
  colores = colores_room_type,  # Colores personalizados
  title = "Distribuci√≥n de Precios por Tipo de Propiedad en Airbnb",  # T√≠tulo del gr√°fico
  xlab = "Tipo de Propiedad",  # Etiqueta del eje X (se puede ajustar)
  ylab = "Precio",  # Etiqueta del eje Y
  tickangle = -90  # üîπ Rotar etiquetas del eje X (opcional)
) %>%
  layout(
    xaxis = list(
      categoryorder = "total descending",  # Ordenar por cantidad de registros
      showticklabels = TRUE  # üîπ Mostrar solo las etiquetas que cumplen la condici√≥n
    )
  )

# Mostrar el gr√°fico interactivo
p_boxplot_precio


```

# üìå Cuantitativa vs Cuantitativa (Diagrama de Dispersi√≥n de Precio vs Disponibilidad)

```{r}
# Filtrar datos con barrios seleccionados y precios v√°lidos
filtered_data <- airbnb_data %>%
  filter(price > 0, price < 3000, neighbourhood_cleansed %in% barrios_seleccionados)

# Crear gr√°fico de dispersi√≥n con la funci√≥n
p_scatter_price_bathrooms <- crear_scatterplot(
  data = filtered_data,
  x = "bathrooms",
  y = "price",
  title = "Relaci√≥n entre N√∫mero de Ba√±os y Precio en Airbnb",
  xlab = "N√∫mero de Ba√±os",
  ylab = "Precio (USD)",
  color = NULL,
  colores = "steelblue"
) +
  scale_x_continuous(breaks = sort(unique(airbnb_data$bathrooms))) +  # Mostrar todos los valores de bathrooms
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotar etiquetas para mayor claridad
  )

# Guardar el gr√°fico
guardar_grafico(p_scatter_price_bathrooms, here("reportes/Proy_Airbnb/resultados_generados/scatter_price_bathrooms.png"))

# Convertir a gr√°fico interactivo
convertir_interactivo(p_scatter_price_bathrooms)


```
